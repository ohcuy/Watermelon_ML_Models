"""
ğŸ‰ ìˆ˜ë°• ë‹¹ë„ ì˜ˆì¸¡ ML í”„ë¡œì íŠ¸ - Mel í•„í„° Export ìŠ¤í¬ë¦½íŠ¸
Swiftì™€ Python ê°„ ë™ì¼í•œ mel í•„í„°ë±…í¬ ì‚¬ìš©ì„ ìœ„í•œ í•„í„° ì¶”ì¶œ ë° ë³€í™˜
"""

import numpy as np
import librosa
import json
from pathlib import Path
import sys
import os

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì„¤ì •
project_root = Path(__file__).parent.parent
sys.path.append(str(project_root))

from src.data.feature_extractor import AudioFeatureExtractor

def export_mel_filters():
    """
    librosaì™€ ë™ì¼í•œ mel í•„í„°ë±…í¬ë¥¼ Swiftì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ export
    """
    # ì„¤ì • (feature_extractorì™€ ë™ì¼í•˜ê²Œ)
    extractor = AudioFeatureExtractor()
    config = extractor.config['features']['mel_spectrogram']
    
    sr = 22050  # ì„œë²„ì—ì„œ ì‚¬ìš©í•˜ëŠ” sample rate
    n_fft = config['n_fft']
    n_mels = config['n_mels']
    fmin = config['fmin']
    fmax = config['fmax']
    
    print(f"ğŸ”§ Mel í•„í„° ì„¤ì •:")
    print(f"  - Sample Rate: {sr}")
    print(f"  - FFT Size: {n_fft}")
    print(f"  - Mel Bins: {n_mels}")
    print(f"  - Frequency Range: {fmin} - {fmax} Hz")
    
    # librosa mel í•„í„° ìƒì„±
    mel_filter = librosa.filters.mel(
        sr=sr, 
        n_fft=n_fft, 
        n_mels=n_mels, 
        fmin=fmin, 
        fmax=fmax,
        htk=False,  # Slaney ë°©ì‹ ì‚¬ìš©
        norm='slaney'  # Slaney normalization
    )
    
    print(f"  - ìƒì„±ëœ í•„í„° shape: {mel_filter.shape}")
    
    # exports ë””ë ‰í† ë¦¬ ìƒì„±
    exports_dir = project_root / "exports"
    exports_dir.mkdir(exist_ok=True)
    
    # 1. NumPy í˜•íƒœë¡œ ì €ì¥
    np.save(exports_dir / "mel_filter.npy", mel_filter)
    print(f"âœ… NumPy íŒŒì¼ ì €ì¥: {exports_dir / 'mel_filter.npy'}")
    
    # 2. í…ìŠ¤íŠ¸ í˜•íƒœë¡œ ì €ì¥
    with open(exports_dir / "mel_filter.txt", "w") as f:
        f.write(f"# Mel Filter Bank\n")
        f.write(f"# Shape: {mel_filter.shape}\n")
        f.write(f"# Sample Rate: {sr}\n")
        f.write(f"# FFT Size: {n_fft}\n")
        f.write(f"# Mel Bins: {n_mels}\n")
        f.write(f"# Frequency Range: {fmin} - {fmax} Hz\n\n")
        
        for i, mel_bin in enumerate(mel_filter):
            f.write(f"# Mel bin {i}\n")
            f.write(",".join([f"{val:.8f}" for val in mel_bin]))
            f.write("\n")
    
    print(f"âœ… í…ìŠ¤íŠ¸ íŒŒì¼ ì €ì¥: {exports_dir / 'mel_filter.txt'}")
    
    # 3. Swift ì½”ë“œë¡œ ë³€í™˜
    generate_swift_code(mel_filter, sr, n_fft, n_mels, fmin, fmax, exports_dir)
    
    # 4. JSON í˜•íƒœë¡œ ì €ì¥ (ë©”íƒ€ë°ì´í„° í¬í•¨)
    filter_data = {
        "metadata": {
            "sample_rate": sr,
            "n_fft": n_fft,
            "n_mels": n_mels,
            "fmin": fmin,
            "fmax": fmax,
            "htk": False,
            "norm": "slaney",
            "shape": mel_filter.shape
        },
        "filter_bank": mel_filter.tolist()
    }
    
    with open(exports_dir / "mel_filter.json", "w") as f:
        json.dump(filter_data, f, indent=2)
    
    print(f"âœ… JSON íŒŒì¼ ì €ì¥: {exports_dir / 'mel_filter.json'}")
    
    # 5. í•„í„° ê²€ì¦
    verify_mel_filters(mel_filter, sr, n_fft, n_mels)

def generate_swift_code(mel_filter, sr, n_fft, n_mels, fmin, fmax, exports_dir):
    """
    Swiftì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì½”ë“œ ìƒì„±
    """
    swift_code = f'''//
//  MelFilterBank.swift
//  ìˆ˜ë°• ë‹¹ë„ ì˜ˆì¸¡ ì•±
//
//  Python librosaì™€ ë™ì¼í•œ mel í•„í„°ë±…í¬
//  Generated by 6_export_mel_filters.py
//

import Foundation
import Accelerate

class MelFilterBank {{
    
    // MARK: - ì„¤ì •
    static let sampleRate: Int = {sr}
    static let fftSize: Int = {n_fft}
    static let melBins: Int = {n_mels}
    static let fmin: Float = {fmin}
    static let fmax: Float = {fmax if fmax else sr // 2}
    
    // MARK: - Mel í•„í„° ë±…í¬ (librosaì™€ ë™ì¼)
    static let melFilterBank: [[Float]] = [
'''
    
    # í•„í„° ë°ì´í„° ì¶”ê°€
    for i, mel_bin in enumerate(mel_filter):
        swift_code += f"        ["
        swift_code += ", ".join([f"{val:.8f}" for val in mel_bin])
        swift_code += "]"
        if i < len(mel_filter) - 1:
            swift_code += ","
        swift_code += "\n"
    
    swift_code += f'''    ]
    
    // MARK: - Mel ìŠ¤í™íŠ¸ë¡œê·¸ë¨ ê³„ì‚°
    static func applyMelFilter(powerSpectrum: [Float]) -> [Float] {{
        guard powerSpectrum.count >= fftSize / 2 + 1 else {{
            return Array(repeating: 0.0, count: melBins)
        }}
        
        var melSpectrum = [Float](repeating: 0.0, count: melBins)
        
        for (melIndex, filterCoeffs) in melFilterBank.enumerated() {{
            var sum: Float = 0.0
            
            for (freqIndex, coeff) in filterCoeffs.enumerated() {{
                if freqIndex < powerSpectrum.count {{
                    sum += coeff * powerSpectrum[freqIndex]
                }}
            }}
            
            melSpectrum[melIndex] = sum
        }}
        
        return melSpectrum
    }}
    
    // MARK: - ê²€ì¦ìš© í•¨ìˆ˜
    static func getFilterShape() -> (Int, Int) {{
        return (melBins, fftSize / 2 + 1)
    }}
    
    static func getFrequencyBins() -> [Float] {{
        let freqStep = Float(sampleRate) / Float(fftSize)
        return (0..<(fftSize / 2 + 1)).map {{ Float($0) * freqStep }}
    }}
    
    static func getMelFrequencies() -> [Float] {{
        let melMin = 2595.0 * log10(1.0 + fmin / 700.0)
        let melMax = 2595.0 * log10(1.0 + fmax / 700.0)
        let melStep = (melMax - melMin) / Float(melBins + 1)
        
        return (0..<(melBins + 2)).map {{ melIndex in
            let mel = melMin + Float(melIndex) * melStep
            return 700.0 * (pow(10.0, mel / 2595.0) - 1.0)
        }}
    }}
}}

// MARK: - ì‚¬ìš© ì˜ˆì‹œ
/*
// FFT í›„ íŒŒì›Œ ìŠ¤í™íŠ¸ëŸ¼ ê³„ì‚°
let powerSpectrum = calculatePowerSpectrum(fftResult)

// Mel í•„í„° ì ìš©
let melSpectrum = MelFilterBank.applyMelFilter(powerSpectrum: powerSpectrum)

// ë¡œê·¸ ë³€í™˜
let logMelSpectrum = melSpectrum.map {{ max(log10($0 + 1e-10), -10.0) }}
*/
'''
    
    # Swift íŒŒì¼ ì €ì¥
    with open(exports_dir / "MelFilterBank.swift", "w") as f:
        f.write(swift_code)
    
    print(f"âœ… Swift ì½”ë“œ ìƒì„±: {exports_dir / 'MelFilterBank.swift'}")

def verify_mel_filters(mel_filter, sr, n_fft, n_mels):
    """
    ìƒì„±ëœ mel í•„í„° ê²€ì¦
    """
    print(f"\nğŸ” Mel í•„í„° ê²€ì¦:")
    print(f"  - í•„í„° ê°œìˆ˜: {len(mel_filter)}")
    print(f"  - ê° í•„í„° ê¸¸ì´: {len(mel_filter[0])}")
    print(f"  - ì˜ˆìƒ ì£¼íŒŒìˆ˜ bin ê°œìˆ˜: {n_fft // 2 + 1}")
    
    # í•„í„° í•© í™•ì¸
    filter_sums = [np.sum(mel_bin) for mel_bin in mel_filter]
    print(f"  - í•„í„° í•© ë²”ìœ„: {min(filter_sums):.4f} ~ {max(filter_sums):.4f}")
    
    # 0ì´ ì•„ë‹Œ ê³„ìˆ˜ í™•ì¸
    non_zero_counts = [np.count_nonzero(mel_bin) for mel_bin in mel_filter]
    print(f"  - 0ì´ ì•„ë‹Œ ê³„ìˆ˜ ê°œìˆ˜: {min(non_zero_counts)} ~ {max(non_zero_counts)}")
    
    # ì£¼íŒŒìˆ˜ ë²”ìœ„ í™•ì¸
    mel_freqs = librosa.mel_frequencies(n_mels + 2, fmin=0, fmax=sr//2)
    print(f"  - Mel ì£¼íŒŒìˆ˜ ë²”ìœ„: {mel_freqs[0]:.1f} ~ {mel_freqs[-1]:.1f} Hz")
    
    print(f"âœ… ê²€ì¦ ì™„ë£Œ!")

if __name__ == "__main__":
    print("ğŸ‰ Mel í•„í„° Export ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰")
    export_mel_filters()
    print("\nğŸ‰ ëª¨ë“  íŒŒì¼ ìƒì„± ì™„ë£Œ!")
    print("Swift í”„ë¡œì íŠ¸ì— MelFilterBank.swift íŒŒì¼ì„ ì¶”ê°€í•˜ì„¸ìš”.")